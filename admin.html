<!DOCTYPE html>
<html lang="en">
<head>
    <title>Admin - Product Management</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Centralized API config -->
    <script src="js/config.js"></script>
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="512x512" href="img/logo.png">
    <link rel="icon" type="image/png" sizes="512x512" href="img/logo.png">
    <link rel="icon" type="image/png" sizes="512x512" href="img/logo.png">
    <link rel="icon" type="image/png" sizes="512x512" href="img/logo.png">
    <link rel="apple-touch-icon" sizes="512x512" href="img/logo.png">
    <meta name="msapplication-TileImage" content="img/logo.png">
    <meta name="theme-color" content="#D4AF37">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #4e73df;
            --secondary-color: #858796;
            --success-color: #1cc88a;
            --light-bg: #f8f9fc;
            --border-color: #e3e6f0;
        }
        
        body {
            background-color: #f8f9fc;
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 0.9rem;
            line-height: 1.6;
            color: #5a5c69;
        }
        
        /* Navigation */
        .navbar {
            background: #fff;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            padding: 0.75rem 1.5rem;
        }
        
        .navbar-brand {
            font-weight: 800;
            font-size: 1.25rem;
            color: #4e73df;
        }
        
        .nav-link {
            color: #5a5c69;
            font-weight: 600;
            padding: 0.5rem 1rem;
            transition: all 0.3s;
        }
        
        .nav-link:hover, .nav-link.active {
            color: var(--primary-color);
        }
        
        /* Main Content */
        .content-wrapper {
            padding: 1.5rem;
            margin-top: 1rem;
        }
        
        .card {
            border: none;
            border-radius: 0.35rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            margin-bottom: 2rem;
        }
        
        .card-header {
            background-color: #f8f9fc;
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 1.25rem;
            font-weight: 700;
            color: #4e73df;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Table Styles */
        .table {
            margin-bottom: 0;
            font-size: 0.85rem;
        }
        
        .table thead th {
            background-color: #f8f9fc;
            color: #5a5c69;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.08em;
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
        }
        
        .table td {
            padding: 1rem;
            vertical-align: middle;
            border-top: 1px solid var(--border-color);
        }
        
        .table-striped > tbody > tr:nth-of-type(odd) > * {
            background-color: #fff;
        }
        
        .table-striped > tbody > tr:nth-of-type(even) > * {
            background-color: #f8f9fc;
        }
        
        /* Buttons */
        .btn {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.4rem 0.8rem;
            border-radius: 0.25rem;
            transition: all 0.2s;
        }
        
        .btn i {
            margin-right: 0.25rem;
        }
        
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* Product Image */
        .product-image { 
            width: 60px; 
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }
        
        .additional-images {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            background-color: #f8f9fa;
            border: 1px dashed var(--border-color);
        }
        
        .additional-image {
            width: 30px;
            height: 30px;
            object-fit: cover;
            border-radius: 3px;
            border: 2px solid #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            background-color: white;
        }
        
        .additional-image:hover {
            transform: scale(2.5);
            z-index: 100;
            position: relative;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            border-color: var(--primary-color);
        }
        
        /* Loading State */
        .loading { 
            opacity: 0.6; 
            pointer-events: none; 
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .content-wrapper {
                padding: 1rem 0.5rem;
            }
            
            .btn-group {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container-fluid">
            <button id="logoutBtn" class="btn btn-outline-danger ms-auto">
                <i class="bi bi-box-arrow-right"></i> Logout
            </button>
            <a class="navbar-brand" href="#">
                <i class="bi bi-gem me-2"></i>Onyxia Admin
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="admin.html">
                            <i class="bi bi-grid me-1"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="index_new.html">View Site</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="admin-orders.html">
                            <i class="bi bi-cart-check me-1"></i> Orders
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="cities.html">
                            <i class="bi bi-geo-alt me-1"></i> Cities
                        </a>
                    </li>
                </ul>
                <div class="d-flex">
                    <a href="index_new.html" class="btn btn-outline-secondary btn-sm me-2">
                        <i class="bi bi-shop"></i> View Shop
                    </a>
                    <button id="refresh-btn" class="btn btn-primary btn-sm">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid content-wrapper">
        <div class="card">
            <div class="card-header">
                <span><i class="bi bi-box-seam me-2"></i>Product Management</span>
                <a href="add-product.html" class="btn btn-success btn-sm">
                    <i class="bi bi-plus-lg"></i> Add New Product
                </a>
            </div>
            <div class="card-body p-0">
            
            <div id="loading-indicator" class="text-center my-4" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading products...</p>
            </div>
            
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark d-none d-md-table-header-group">
                        <tr>
                            <th width="120">Image</th>
                            <th>Name</th>
                            <th width="100">Price</th>
                            <th width="80">Stock</th>
                            <th width="120">Display on Home</th>
                            <th width="100">Position</th>
                            <th width="150">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="product-table-body" class="table-body">
                        <!-- Products will be loaded here -->
                    </tbody>
                </table>
                
                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center p-3 border-top">
                    <div class="text-muted small">
                        Showing <span id="showing-count">0</span> of <span id="total-count">0</span> products
                    </div>
                    <div id="pagination"></div>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="text-center text-muted small py-3">
        &copy; 2025 Kaira Jewelry. All rights reserved.
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    <script src="js/admin-auth.js"></script>
    <script>
        // Show/hide loading state
        function setLoading(isLoading) {
            try {
                const loadingEl = document.getElementById('loading-indicator');
                const container = document.querySelector('.table-responsive') || document.body;
                
                if (loadingEl) {
                    loadingEl.style.display = isLoading ? 'block' : 'none';
                }
                
                if (container) {
                    container.style.opacity = isLoading ? '0.7' : '1';
                    container.style.pointerEvents = isLoading ? 'none' : 'auto';
                }
                
                // Toggle cursor style on body
                document.body.style.cursor = isLoading ? 'wait' : 'default';
                
            } catch (error) {
                console.error('Error in setLoading:', error);
            }
        }

        // Format price with 2 decimal places
        function formatPrice(price) {
            return `$${parseFloat(price || 0).toFixed(2)}`;
        }

        // Store products and pagination state
        window.productsList = [];
        let currentPage = 1;
        const productsPerPage = 8;
        
        function updatePagination(totalProducts) {
            const totalPages = Math.ceil(totalProducts / productsPerPage);
            const paginationEl = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                paginationEl.innerHTML = '';
                return;
            }
            
            let paginationHTML = `
                <nav aria-label="Products pagination">
                    <ul class="pagination justify-content-center mb-0">
                        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                            <button class="page-link" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'tabindex="-1"' : ''}>
                                <i class="bi bi-chevron-left"></i>
                            </button>
                        </li>`;
            
            // Show page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            if (startPage > 1) {
                paginationHTML += `
                    <li class="page-item">
                        <button class="page-link" onclick="changePage(1)">1</button>
                    </li>`;
                if (startPage > 2) {
                    paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <button class="page-link" onclick="changePage(${i})">${i}</button>
                    </li>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
                paginationHTML += `
                    <li class="page-item">
                        <button class="page-link" onclick="changePage(${totalPages})">${totalPages}</button>
                    </li>`;
            }
            
            paginationHTML += `
                        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                            <button class="page-link" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'tabindex="-1"' : ''}>
                                <i class="bi bi-chevron-right"></i>
                            </button>
                        </li>
                    </ul>
                </nav>
                <div class="text-center text-muted small mt-2">
                    Showing ${(currentPage - 1) * productsPerPage + 1} to ${Math.min(currentPage * productsPerPage, totalProducts)} of ${totalProducts} products
                </div>`;
                
            paginationEl.innerHTML = paginationHTML;
        }
        
        function changePage(page) {
            currentPage = page;
            renderProducts();
            // Scroll to top of table
            document.querySelector('.table-responsive')?.scrollIntoView({ behavior: 'smooth' });
        }
        
        function getPaginatedProducts(products) {
            const startIndex = (currentPage - 1) * productsPerPage;
            return products.slice(startIndex, startIndex + productsPerPage);
        }
        
        function renderProducts() {
            const tbody = document.getElementById('product-table-body');
            if (!tbody || !window.productsList) return;
            
            const paginatedProducts = getPaginatedProducts(window.productsList);
            
            tbody.innerHTML = paginatedProducts.map(product => {
                const API_BASE = window.API_BASE_URL || window.location.origin;
                // Process additional images
                const additionalImages = product.additionalImages || product.images || [];
                const validImages = Array.isArray(additionalImages) ? 
                    additionalImages.filter(img => typeof img === 'string' && img.trim() !== '') : [];
                
                // Format price
                const price = parseFloat(product.price || 0).toFixed(2);
                
                // Function to get image URL
                const getImageUrl = (img) => {
                    if (!img) return '';
                    if (typeof img !== 'string') return '';
                    const trimmed = img.trim();
                    if (trimmed.startsWith('data:image')) return trimmed; // legacy base64
                    if (/^https?:\/\//i.test(trimmed)) return trimmed;   // absolute URL
                    if (trimmed.startsWith('/uploads/')) return `${API_BASE}${trimmed}`; // absolute from server
                    if (trimmed.startsWith('uploads/')) return `${API_BASE}/${trimmed}`;
                    // fallback: assume it's a filename stored
                    return `${API_BASE}/uploads/${trimmed.split('/').pop()}`;
                };
                
                // Get main image URL
                const mainImageUrl = getImageUrl(product.image || product.imageUrl);
                
                // Create additional images HTML
                let additionalImagesHtml = '';
                if (validImages.length > 0) {
                    additionalImagesHtml = `
                        <div class="additional-images mt-1 d-flex flex-wrap gap-1">
                            ${validImages.map((img, index) => {
                                const imgSrc = getImageUrl(img);
                                return `
                                <div class="additional-image-container">
                                    <img src="${imgSrc}" 
                                         class="additional-image img-thumbnail" 
                                         alt="Additional ${index + 1}" 
                                         title="Additional image ${index + 1}">
                                </div>`;
                            }).join('')}
                        </div>`;
                }
                
                return `
                    <tr>
                        <td data-label="Image">
                            <div class="d-flex flex-column align-items-center">
                                ${mainImageUrl ? 
                                    `<img src="${mainImageUrl}" 
                                          class="product-image img-thumbnail" 
                                          alt="${product.name}">` : 
                                    '<span class="text-muted">No image</span>'}
                                ${additionalImagesHtml}
                            </div>
                        </td>
                        <td class="align-middle" data-label="Name">
                            <div class="product-name-cell">${product.name || 'Unnamed Product'}</div>
                        </td>
                        <td class="align-middle" data-label="Price">
                            <div>$${price}</div>
                        </td>
                        <td class="align-middle" data-label="Stock">
                            <div class="stock-status ${product.stock?.status === 'متاح' ? 'text-success' : 'text-danger'}" 
                                 style="font-weight: 500;">
                                ${product.stock?.status || 'غير متاح'}
                            </div>
                            <small class="text-muted">(${product.stock?.quantity || 0})</small>
                        </td>
                        <td class="align-middle" data-label="Display on Home">
                            <div class="form-check form-switch d-flex justify-content-center">
                                <input class="form-check-input display-home-toggle" type="checkbox" 
                                       data-product-id="${product._id || product.id}" 
                                       ${product.display_home ? 'checked' : ''}
                                       style="width: 3em; height: 1.5em; cursor: pointer;">
                            </div>
                        </td>
                        <td class="align-middle" data-label="Position">
                            <input type="number" 
                                   class="form-control form-control-sm position-input" 
                                   data-product-id="${product._id || product.id}"
                                   value="${product.display_home ? (product.home_position || 1) : 0}" 
                                   min="1" 
                                   style="width: 70px;"
                                   ${!product.display_home ? 'disabled' : ''}
                                   oninput="this.value = Math.max(1, parseInt(this.value) || 1)">
                        </td>
                        <td class="align-middle" data-label="Actions">
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="edit.html?id=${product._id || product.id}" class="btn btn-primary">
                                    <i class="bi bi-pencil"></i> <span class="d-none d-md-inline">Edit</span>
                                </a>
                                <button type="button" class="btn btn-danger delete-btn" data-id="${product._id || product.id}">
                                    <i class="bi bi-trash"></i> <span class="d-none d-md-inline">Delete</span>
                                </button>
                            </div>
                        </td>
                    </tr>`;
            }).join('');
            
            // Update pagination
            updatePagination(window.productsList.length);
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const productId = e.target.closest('button').dataset.id;
                    const productName = e.target.closest('tr').querySelector('.product-name-cell').textContent;
                    showDeleteConfirmation(productId, productName);
                });
            });
            
            // Add event listeners for display_home toggle
            document.querySelectorAll('.display-home-toggle').forEach(toggle => {
                toggle.addEventListener('change', async (e) => {
                    const productId = e.target.dataset.productId;
                    const isChecked = e.target.checked;
                    const positionInput = document.querySelector(`.position-input[data-product-id="${productId}"]`);
                    
                    // Show loading state
                    const originalText = e.target.checked ? 'ON' : 'OFF';
                    e.target.disabled = true;
                    
                    try {
                        // Update the product
                        await window.api.products.updateProduct(productId, {
                            display_home: isChecked,
                            home_position: isChecked ? (parseInt(positionInput?.value) || 1) : 0
                        });
                        
                        // Update UI immediately for better UX
                        if (positionInput) {
                            positionInput.disabled = !isChecked;
                            if (isChecked && (!positionInput.value || positionInput.value === '0')) {
                                positionInput.value = '1';
                            } else if (!isChecked) {
                                positionInput.value = '0';
                            }
                        }
                        
                        // Refresh the product list to update the sort order
                        await loadProducts();
                    } catch (error) {
                        console.error('Error updating product display status:', error);
                        alert('Error updating product. Please try again.');
                        e.target.checked = !isChecked; // Revert the toggle on error
                    } finally {
                        e.target.disabled = false;
                    }
                });
            });
            
            // Add event listeners for position input changes
            document.querySelectorAll('.position-input').forEach(input => {
                input.addEventListener('change', async (e) => {
                    const productId = e.target.dataset.productId;
                    const position = Math.max(1, parseInt(e.target.value) || 1); // Ensure position is at least 1
                    
                    // Update the input value in case it was changed
                    e.target.value = position;
                    
                    // Show loading state
                    const originalValue = e.target.value;
                    e.target.disabled = true;
                    
                    try {
                        // Update the product
                        await window.api.products.updateProduct(productId, {
                            home_position: position
                        });
                        
                        // Refresh the product list to update the sort order
                        await loadProducts();
                    } catch (error) {
                        console.error('Error updating product position:', error);
                        alert('Error updating product position. Please try again.');
                        e.target.value = originalValue; // Revert the value on error
                    } finally {
                        e.target.disabled = false;
                    }
                });
            });
        }

        async function loadProducts() {
            const tbody = document.getElementById('product-table-body');
            const paginationEl = document.getElementById('pagination');
            
            if (!tbody || !paginationEl) {
                console.error('Required elements not found');
                return;
            }
            
            // Show loading state
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></tr>';
            
            try {
                setLoading(true);
                console.log('Fetching products from API...');
                const products = await window.dbOperations.products.getAllProducts();
                
                if (!products || !Array.isArray(products)) {
                    throw new Error('Invalid products data received');
                }
                
                console.log('=== PRODUCTS DATA FROM SERVER ===');
                console.log('Raw products data:', JSON.parse(JSON.stringify(products)));
                
                // Log detailed info about each product
                products.forEach((product, index) => {
                    console.log(`\n--- Product ${index + 1} ---`);
                    console.log('ID:', product._id || product.id);
                    console.log('Name:', product.name);
                    console.log('Main Image:', product.image ? 'Exists' : 'None');
                    console.log('Main Image Value:', product.image);
                    console.log('All product properties:', Object.keys(product));
                    
                    // Check for additional images in different possible properties
                    const additionalImages = product.additionalImages || product.images || [];
                    console.log('Additional Images:', additionalImages);
                });
                
                // Sort products by home_position (only for products with display_home: true)
                const sortedProducts = [...products].sort((a, b) => {
                    if (a.display_home && b.display_home) {
                        return (a.home_position || 0) - (b.home_position || 0);
                    }
                    if (a.display_home) return -1;
                    if (b.display_home) return 1;
                    return 0;
                });
                
                // Store sorted products globally
                window.productsList = sortedProducts;
                
                if (products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No products found. <a href="add-product.html" class="text-primary">Add your first product</a></td></tr>';
                    paginationEl.innerHTML = '';
                    return;
                }
                
                // Reset to first page when loading new data
                currentPage = 1;
                renderProducts();
                
                // Debug: Log all products and their structure with detailed property inspection
                console.log('=== PRODUCTS DATA FROM SERVER ===');
                console.log('Raw products data:', JSON.parse(JSON.stringify(products)));
                
                // Log detailed info about each product
                products.forEach((product, index) => {
                    console.log(`\n--- Product ${index + 1} ---`);
                    console.log('ID:', product._id || product.id);
                    console.log('Name:', product.name);
                    console.log('Main Image:', product.image ? 'Exists' : 'None');
                    
                    // Log all properties of the product to check for additional images
                    console.log('All product properties:', Object.keys(product));
                    
                    // Check for additional images in different possible properties
                    const additionalImages = product.additionalImages || product.images || [];
                    console.log('Additional Images Raw:', additionalImages);
                    console.log('Additional Images Type:', Array.isArray(additionalImages) ? 'Array' : typeof additionalImages);
                    
                    if (additionalImages && Array.isArray(additionalImages)) {
                        console.log('Number of Additional Images:', additionalImages.length);
                        if (additionalImages.length > 0) {
                            console.log('First Additional Image URL (first 50 chars):', 
                                additionalImages[0].substring(0, 50) + '...');
                            console.log('First Additional Image Complete URL:', additionalImages[0].length > 100 ? 
                                additionalImages[0].substring(0, 100) + '...' : additionalImages[0]);
                        }
                    } else {
                        console.log('Additional Images is not an array or is empty');
                    }
                });
                
                // Products are now rendered via renderProducts()
                // This code is now handled in the renderProducts() function
                
            } catch (error) {
                console.error('Error loading products:', error);
                const errorMessage = error.response?.data?.message || error.message || 'Failed to load products';
                
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-danger py-4">
                            <div class="alert alert-danger mb-0">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                ${errorMessage}
                                <div class="mt-2">
                                    <button onclick="loadProducts()" class="btn btn-sm btn-outline-danger">
                                        <i class="bi bi-arrow-clockwise"></i> Retry
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>`;
            } finally {
                setLoading(false);
                
                // Re-initialize any tooltips or plugins if needed
                if (window.bootstrap && window.bootstrap.Tooltip) {
                    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                    tooltipTriggerList.map(function (tooltipTriggerEl) {
                        return new window.bootstrap.Tooltip(tooltipTriggerEl);
                    });
                }
            }
        }

        // Function to refresh the product list
        async function refreshProductList() {
            try {
                await loadProducts();
                console.log('Product list refreshed');
            } catch (error) {
                console.error('Error refreshing product list:', error);
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            // Add refresh button event
            document.getElementById('refresh-btn').addEventListener('click', refreshProductList);
            
            // Load products on page load
            await refreshProductList();
            
            // Listen for custom event to refresh products
            document.addEventListener('productAdded', function() {
                console.log('Received productAdded event, refreshing product list...');
                refreshProductList().then(() => {
                    console.log('Product list refreshed successfully');
                }).catch(error => {
                    console.error('Error refreshing product list:', error);
                });
            });
            
            // Check if dbOperations is available
            if (!window.dbOperations) {
                document.getElementById('product-table-body').innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-danger">
                            Error: Database operations not available. Make sure api.js is loaded.
                        </td>
                    </tr>`;
                return;
            }
            
            // Initial load
            await loadProducts();
        });
    </script>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteConfirmationModalLabel">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>Confirm Deletion
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0 me-3 text-danger">
                            <i class="bi bi-exclamation-octagon-fill fs-1"></i>
                        </div>
                        <div>
                            <h5 class="mb-1">Are you sure?</h5>
                            <p class="mb-0" id="deleteProductDetails">This action cannot be undone.</p>
                        </div>
                    </div>
                    <div class="alert alert-warning d-flex align-items-center" role="alert">
                        <i class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2"></i>
                        <div>
                            This will permanently delete the product and all its data.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg me-1"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="bi bi-trash-fill me-1"></i> Delete Permanently
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Base table styles */
        .table {
            --bs-table-bg: transparent;
            --bs-table-striped-bg: rgba(0, 0, 0, 0.02);
            --bs-table-hover-bg: rgba(0, 0, 0, 0.03);
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 1.5rem;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .table thead th {
            background-color: #f1f3f5;
            border-bottom: 2px solid #e9ecef;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            padding: 1rem 1.25rem;
            vertical-align: middle;
            color: #495057;
            white-space: nowrap;
            position: relative;
        }
        
        .table thead th:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 1px;
            height: 60%;
            background-color: #dee2e6;
        }
        
        .table tbody td {
            padding: 1rem 1.25rem;
            vertical-align: middle;
            border-top: 1px solid #f0f0f0;
            transition: all 0.2s ease;
            color: #495057;
            position: relative;
        }
        
        .table tbody tr:hover td {
            background-color: #f8f9fa;
            transform: translateX(2px);
        }
        
        .table tbody tr:first-child td {
            border-top: none;
        }
        
        .table-striped > tbody > tr:nth-of-type(odd) > * {
            --bs-table-accent-bg: rgba(241, 243, 245, 0.5);
            color: var(--bs-table-striped-color);
        }
        
        .table-hover > tbody > tr:hover > * {
            --bs-table-accent-bg: #f1f8ff;
            color: var(--bs-table-hover-color);
        }
        
        /* Product image styles */
        .product-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #eee;
            transition: transform 0.2s ease;
        }
        
        .product-image:hover {
            transform: scale(1.05);
        }
        
        .additional-images {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }
        
        .additional-image {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 3px;
            border: 1px solid #eee;
            transition: transform 0.2s ease;
        }
        
        .additional-image:hover {
            transform: scale(1.1);
            z-index: 1;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* Action buttons */
        .btn-group-sm > .btn, .btn-sm {
            padding: 0.3rem 0.75rem;
            font-size: 0.8rem;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }
        
        .btn-group-sm > .btn:hover, .btn-sm:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Status indicators */
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: capitalize;
        }
        
        .status-active {
            background-color: #e3f5ee;
            color: #0d6e42;
        }
        
        .status-inactive {
            background-color: #fff0f0;
            color: #dc3545;
        }
        
        /* Pagination styles */
        .pagination {
            margin: 0;
        }
        
        .page-link {
            color: #495057;
            border: 1px solid #dee2e6;
            padding: 0.5rem 0.75rem;
            min-width: 38px;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .page-item.active .page-link {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: white;
        }
        
        .page-item.disabled .page-link {
            color: #6c757d;
            pointer-events: none;
            background-color: #fff;
            border-color: #dee2e6;
        }
        
        .page-link:hover {
            background-color: #e9ecef;
            border-color: #dee2e6;
            color: #0a58ca;
        }
        
        .page-item.active .page-link:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
            color: white;
        }
        
        /* Make pagination responsive */
        @media (max-width: 576px) {
            .pagination {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .page-item {
                margin: 0.2rem;
            }
            
            .page-link {
                padding: 0.375rem 0.5rem;
                min-width: 34px;
                font-size: 0.875rem;
            }
        }
        
        /* Responsive button styles */
        @media (max-width: 767.98px) {
            .btn-group {
                flex-wrap: wrap;
                gap: 0.25rem;
                justify-content: flex-end;
            }
            
            .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.8rem;
            }
            
            .btn i {
                margin-right: 0.25rem;
            }
            
            .d-flex.justify-content-between.align-items-center {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            h3 {
                margin-bottom: 0.5rem !important;
            }
        }
        
        /* Responsive table styles */
        @media (max-width: 767.98px) {
            .table-responsive {
                border: 1px solid #dee2e6;
                border-radius: 0.25rem;
                overflow: hidden;
            }
            
            .table thead {
                display: none;
            }
            
            .table tbody tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid #dee2e6;
                border-radius: 0.25rem;
                padding: 0.5rem;
                position: relative;
            }
            
            .table tbody td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.5rem;
                border: none;
                border-bottom: 1px solid #f2f2f2;
            }
            
            .table tbody td:before {
                content: attr(data-label);
                font-weight: 600;
                margin-right: 1rem;
                flex: 1;
            }
            
            .table tbody td > div {
                flex: 2;
                text-align: right;
            }
            
            .table tbody .btn-group {
                justify-content: flex-end;
                width: 100%;
            }
            
            .table tbody .product-image {
                max-width: 60px;
                height: auto;
                margin: 0 auto;
            }
            
            .table tbody .additional-images {
                justify-content: flex-end;
            }
        }
        
        /* Desktop styles */
        @media (min-width: 768px) {
            .table tbody .product-image {
                width: 80px;
                height: 80px;
                object-fit: cover;
                border-radius: 0.25rem;
            }
            
            .additional-images {
                display: flex;
                gap: 0.25rem;
                flex-wrap: wrap;
                max-width: 200px;
            }
            
            .additional-images img {
                width: 30px;
                height: 30px;
                object-fit: cover;
                border-radius: 0.25rem;
                border: 1px solid #dee2e6;
                transition: transform 0.2s;
            }
            
            .additional-images img:hover {
                transform: scale(1.5);
                z-index: 1;
                position: relative;
                box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.2);
            }
        }
        
        /* Custom styles for the delete confirmation modal */
        #deleteConfirmationModal .modal-content {
            border: none;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        #deleteConfirmationModal .modal-header {
            border-bottom: none;
            padding: 1.25rem 1.5rem;
        }
        
        #deleteConfirmationModal .modal-body {
            padding: 1.5rem;
        }
        
        #deleteConfirmationModal .modal-footer {
            border-top: 1px solid #dee2e6;
            padding: 1rem 1.5rem;
            background-color: #f8f9fa;
        }
        
        #deleteConfirmationModal .btn-danger {
            padding: 0.5rem 1.25rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        #deleteConfirmationModal .btn-danger:hover {
            background-color: #dc3545;
            border-color: #dc3545;
            transform: translateY(-1px);
        }
        
        #deleteConfirmationModal .alert {
            border-left: 4px solid #ffc107;
            border-radius: 0.25rem;
            margin-bottom: 0;
        }
        
        /* Additional images styling */
        .additional-images {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }
        
        .additional-image-container {
            position: relative;
            width: 40px;
            height: 40px;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            overflow: hidden;
        }
        
        .additional-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .product-image {
            max-width: 100px;
            max-height: 100px;
            width: auto;
            height: auto;
            object-fit: contain;
        }
        
        .img-thumbnail {
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            padding: 0.25rem;
        }
    </style>

    <script>
        // Initialize the modal
        let deleteModal = null;
        let currentProductId = null;
        let currentProductName = '';
        
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize the modal
            deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
            
            // Set up the confirm delete button
            document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
                if (!currentProductId) return;
                
                try {
                    setLoading(true);
                    await window.dbOperations.products.deleteProduct(currentProductId);
                    
                    // Show success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show';
                    alertDiv.role = 'alert';
                    alertDiv.innerHTML = `
                        Product "${currentProductName}" has been deleted successfully.
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    
                    // Add the alert before the table
                    const table = document.querySelector('table');
                    table.parentNode.insertBefore(alertDiv, table);
                    
                    // Close the modal
                    deleteModal.hide();
                    
                    // Reload the products list
                    await loadProducts();
                    
                    // Auto-hide the alert after 5 seconds
                    setTimeout(() => {
                        const bsAlert = new bootstrap.Alert(alertDiv);
                        bsAlert.close();
                    }, 5000);
                    
                } catch (error) {
                    console.error('Error deleting product:', error);
                    alert(`Error deleting product: ${error.message}`);
                } finally {
                    setLoading(false);
                    currentProductId = null;
                    currentProductName = '';
                }
            });
        });
        
        // Function to show delete confirmation
        function showDeleteConfirmation(productId, productName) {
            currentProductId = productId;
            currentProductName = productName;
            document.getElementById('deleteProductDetails').innerHTML = 
                `You are about to delete <strong>"${productName}"</strong>. This action cannot be undone.`;
            deleteModal.show();
        }
    </script>

    <!-- Facebook Pixel NoScript -->
    <!--#include virtual="/includes/facebook-pixel-noscript.html" -->
    <!-- End Facebook Pixel NoScript -->
    
    <!-- Admin Authentication -->
    <script src="js/admin-auth.js"></script>
</body>
</html>
