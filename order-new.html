<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order - Kaira</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      max-width: 600px; 
      margin: 40px auto; 
      padding: 20px;
      line-height: 1.6;
    }
    
    h1 { 
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }
    
    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      text-decoration: none;
      color: #4CAF50;
    }
    
    .form-group { 
      margin-bottom: 20px;
    }
    
    label { 
      display: block; 
      margin-bottom: 8px; 
      font-weight: bold;
      color: #333;
    }
    
    .required::after {
      content: ' *';
      color: #e74c3c;
    }
    
    input, 
    textarea, 
    select { 
      width: 100%; 
      padding: 12px; 
      margin-bottom: 5px; 
      border: 1px solid #ddd; 
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 16px;
    }
    
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    button { 
      background: #4CAF50; 
      color: white; 
      padding: 15px; 
      border: none; 
      border-radius: 4px;
      cursor: pointer; 
      font-size: 16px;
      width: 100%;
      font-weight: bold;
      transition: background 0.3s;
    }
    
    button:hover {
      background: #45a049;
    }
    
    button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    
    .product-summary {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 4px;
      margin-bottom: 25px;
      border: 1px solid #eee;
    }
    
    .product-summary p {
      margin: 5px 0;
      font-size: 16px;
    }
    
    .product-summary .price {
      font-size: 20px;
      font-weight: bold;
      color: #2e7d32;
    }
    
    #log {
      margin-top: 30px;
      padding: 15px;
      border: 1px solid #eee;
      border-radius: 4px;
      font-family: monospace;
      font-size: 13px;
      background: #f9f9f9;
      max-height: 200px;
      overflow-y: auto;
      display: none; /* Hidden by default */
    }
    
    .log-entry {
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 3px;
      font-size: 13px;
    }
    
    .log-info {
      background: #e8f5e9;
      border-left: 3px solid #4CAF50;
    }
    
    .log-error {
      background: #ffebee;
      border-left: 3px solid #f44336;
    }
    
    .loading {
      display: inline-block;
      margin-left: 10px;
    }
    
    @media (max-width: 480px) {
      body {
        padding: 15px;
        margin: 20px 10px;
      }
      
      h1 {
        font-size: 24px;
      }
      
      input, 
      textarea, 
      select {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <a href="shop.html" class="back-link">‚Üê Back to Shop</a>
  <h1>Place Your Order</h1>
  
  <style>
    .product-summary {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .product-details {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .product-image-container {
      width: 100px;
      height: 100px;
      border-radius: 8px;
      overflow: hidden;
      flex-shrink: 0;
      border: 1px solid #eee;
    }
    .product-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .product-info {
      flex-grow: 1;
    }
    .product-name {
      font-size: 1.2rem;
      font-weight: 600;
      margin: 0 0 10px 0;
      color: #333;
    }
    .product-price {
      font-size: 1.1rem;
      color: #b8860b;
      font-weight: 600;
      margin: 0;
    }
  </style>

  <div class="product-summary">
    <h2>Order Summary</h2>
    <div class="product-details">
      <div class="product-image-container">
        <img id="productImage" src="" alt="Product Image" class="product-image">
      </div>
      <div class="product-info">
        <h3 id="displayProduct" class="product-name">-</h3>
        <p class="product-price">Price: <span id="displayPrice">-</span> TND</p>
      </div>
    </div>
  </div>
  
  <form id="orderForm">
    <!-- Hidden product fields -->
    <input type="hidden" id="productId" name="productId">
    <input type="hidden" id="productName" name="productName">
    <input type="hidden" id="productPrice" name="productPrice">
    
    <div class="form-group">
      <label for="fullName" class="required">Full Name</label>
      <input type="text" id="fullName" name="fullName" required 
             placeholder="Your full name" aria-label="Full Name">
    </div>
    
    <div class="form-group">
      <label for="phone" class="required">Phone Number</label>
      <input type="tel" id="phone" name="phone" required 
             placeholder="Your phone number" aria-label="Phone Number">
    </div>
    
    <div class="form-group">
      <label for="email">Email (Optional)</label>
      <input type="email" id="email" name="email" 
             placeholder="your.email@example.com" aria-label="Email">
    </div>
    
    <div class="form-group">
      <label for="city" class="required">City</label>
      <input type="text" id="city" name="city" required 
             placeholder="Your city" aria-label="City">
    </div>
    
    <div class="form-group">
      <label class="required">Delivery Method</label>
      <div style="margin: 10px 0;">
        <input type="radio" id="homeDelivery" name="deliveryType" value="home" checked>
        <label for="homeDelivery" style="display:inline; margin-left:5px;">Home Delivery</label>
        
        <input type="radio" id="pickup" name="deliveryType" value="pickup" style="margin-left:20px;">
        <label for="pickup" style="display:inline; margin-left:5px;">Store Pickup</label>
      </div>
    </div>
    
    <div class="form-group" id="addressField">
      <label for="address" class="required">Delivery Address</label>
      <textarea id="address" name="address" required 
                placeholder="Your full delivery address" 
                aria-label="Delivery Address"></textarea>
    </div>
    
    <div class="form-group">
      <label for="notes">Additional Notes (Optional)</label>
      <textarea id="notes" name="notes" 
                placeholder="Any special instructions or notes about your order..." 
                aria-label="Additional Notes"></textarea>
    </div>
    
    <button type="submit" id="submitBtn">
      <span id="submitText">Place Order</span>
      <span id="loadingIndicator" style="display:none;">Processing...</span>
    </button>
  </form>
  
  <div id="log">
    <h3>Order Status</h3>
    <div id="logEntries"></div>
  </div>
  
  <script>
    // Log function for displaying messages
    function log(message, isError = false) {
      const logEl = document.getElementById('log');
      const logEntries = document.getElementById('logEntries');
      const timestamp = new Date().toLocaleTimeString();
      
      // Create log entry
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry ${isError ? 'log-error' : 'log-info'}`;
      logEntry.textContent = `[${timestamp}] ${message}`;
      
      // Add to log
      logEntries.prepend(logEntry);
      logEl.style.display = 'block';
      
      // Also log to console
      if (isError) {
        console.error(`[ORDER ERROR] ${message}`);
      } else {
        console.log(`[ORDER] ${message}`);
      }
      
      return logEntry;
    }
    
    // Get URL parameter
    function getUrlParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }
    
    // Toggle loading state
    function setLoading(isLoading) {
      const btn = document.getElementById('submitBtn');
      const btnText = document.getElementById('submitText');
      const loading = document.getElementById('loadingIndicator');
      
      if (isLoading) {
        btn.disabled = true;
        btnText.style.display = 'none';
        loading.style.display = 'inline';
      } else {
        btn.disabled = false;
        btnText.style.display = 'inline';
        loading.style.display = 'none';
      }
    }
    
    // Format price
    function formatPrice(price) {
      return parseFloat(price).toFixed(2);
    }
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', () => {
      // Show loading state while initializing
      setLoading(true);
      log('Initializing order form...');
      
      try {
        // Get product details from URL
        const productId = getUrlParam('id');
        const productName = getUrlParam('name');
        const productPrice = getUrlParam('price');
        const productImage = getUrlParam('image');
        
        if (productId && productName && productPrice) {
          // Set product details in form
          document.getElementById('productId').value = productId;
          document.getElementById('productName').value = decodeURIComponent(productName);
          document.getElementById('productPrice').value = productPrice;
          
          // Update display
          document.getElementById('displayProduct').textContent = decodeURIComponent(productName);
          document.getElementById('displayPrice').textContent = formatPrice(productPrice);
          
          // Set product image if available
          if (productImage) {
            const decodedImageUrl = decodeURIComponent(productImage);
            document.getElementById('productImage').src = decodedImageUrl;
            document.getElementById('productImage').alt = decodeURIComponent(productName);
            log(`Product image URL: ${decodedImageUrl}`);
          } else {
            // Set a default placeholder image using a data URL
            const placeholderSVG = 'data:image/svg+xml;base64,' + btoa(`
              <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' fill='%23f0f0f0'>
                <rect width='100' height='100' fill='%23f8f9fa'/>
                <path d='M30,40 L70,40 L70,60 L30,60 Z' fill='%23e9ecef'/>
                <path d='M40,30 L60,30 L60,70 L40,70 Z' fill='%23e9ecef'/>
                <text x='50' y='50' font-family='Arial' font-size='10' text-anchor='middle' fill='%26%23adb5bd;'>No Image</text>
              </svg>
            `.trim());
            document.getElementById('productImage').src = placeholderSVG;
            document.getElementById('productImage').alt = 'No product image available';
          }
          
          log(`Product loaded: ${decodeURIComponent(productName)} (${formatPrice(productPrice)} TND)`);
        } else {
          throw new Error('Missing product information in URL');
        }
        
        // Set up delivery type toggle
        function updateAddressField() {
          const deliveryType = document.querySelector('input[name="deliveryType"]:checked').value;
          const addressField = document.getElementById('addressField');
          addressField.style.display = deliveryType === 'home' ? 'block' : 'none';
          
          if (deliveryType === 'pickup') {
            log('Store pickup selected - address not required');
          }
        }
        
        // Add event listeners for delivery type toggle
        document.querySelectorAll('input[name="deliveryType"]').forEach(radio => {
          radio.addEventListener('change', updateAddressField);
        });
        
        // Initialize address field visibility
        updateAddressField();
        
        // Form submission
        document.getElementById('orderForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          setLoading(true);
          
          try {
            const form = e.target;
            const formData = new FormData(form);
            
            // Basic validation
            if (!form.checkValidity()) {
              throw new Error('Please fill in all required fields');
            }
            
            // Prepare order data
            const orderData = {
              // Product info
              product: {
                id: formData.get('productId'),
                name: formData.get('productName'),
                price: parseFloat(formData.get('productPrice'))
              },
              
              // Customer info
              customer: {
                name: formData.get('fullName').trim(),
                phone: formData.get('phone').trim(),
                email: formData.get('email')?.trim() || null,
                city: formData.get('city').trim()
              },
              
              // Delivery info
              delivery: {
                type: formData.get('deliveryType'),
                address: formData.get('deliveryType') === 'home' 
                  ? formData.get('address').trim() 
                  : 'Store Pickup',
                notes: formData.get('notes')?.trim() || null
              },
              
              // System info
              status: 'pending',
              orderDate: new Date().toISOString()
            };
            
            log('Submitting order...');
            
            // Simulate API call (replace with your actual API endpoint)
            const response = await fetch('http://localhost:5001/api/orders', {
              method: 'POST',
              headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              body: JSON.stringify(orderData)
            });
            
            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              throw new Error(errorData.message || 'Failed to submit order');
            }
            
            const result = await response.json();
            log(`Order submitted successfully! Order ID: ${result.orderId || 'N/A'}`);
            
            // Show success message
            alert('Thank you for your order! We will contact you soon.');
            
            // Optionally redirect to thank you page
            // window.location.href = '/thank-you.html';
            
          } catch (error) {
            log(`Error: ${error.message}`, true);
            alert(`Error: ${error.message}`);
          } finally {
            setLoading(false);
          }
        });
        
        log('Order form ready');
        
      } catch (error) {
        log(`Initialization error: ${error.message}`, true);
      } finally {
        setLoading(false);
      }
    });
  </script>
</body>
</html>
